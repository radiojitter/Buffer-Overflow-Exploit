//VulnerableServer.c 

#include "stdafx.h"
#include "winsock.h"
#include "windows.h"
//load windows socket
#pragma comment(lib, "wsock32.lib")
//Define Return Messages
#define SS_ERROR 1
#define SS_OK 0

void sError(char * str)
{
	printf("Error %s", str);
	WSACleanup();
}
char str[5000];
int  main(int argc, char * argv[])
{
	WORD sockVersion;
	WSADATA wsaData;
	int rVal;
	int bytesRecv;
	u_short LocalPort = 1200;
	SOCKET clientSocket;
	SOCKADDR_IN sin;
	SOCKET serverSocket;

     //Loading Library File
	HINSTANCE hDLL = LoadLibrary(_T("C:\\ConsoleApplication4\\Debug\\dll.dll"));
	char message[100] = "";
	if (argv[1] == '\0')
	{
		//wsock32 initialized for usage
		sockVersion = MAKEWORD(1, 1);
		WSAStartup(sockVersion, &wsaData);

		//create server socket
		serverSocket = socket(AF_INET, SOCK_STREAM, 0);

		if (serverSocket == INVALID_SOCKET)
		{
			sError("Failed socket()");
			return SS_ERROR;
		}
		sin.sin_family = AF_INET;
		sin.sin_port = htons(LocalPort);
		sin.sin_addr.s_addr = htonl(INADDR_ANY);

		//bind the socket
		rVal = bind(serverSocket, (LPSOCKADDR)&sin, sizeof(sin));
		if (rVal == SOCKET_ERROR)
		{
			sError("Failed bind()");
			WSACleanup();
			return SS_ERROR;
		}

		//get socket to listen
		rVal = listen(serverSocket, 10);
		if (rVal == SOCKET_ERROR)
		{
			sError("Failed listen()");
			WSACleanup();
			return SS_ERROR;
		}
		else
		{
			printf("Listening");
		}

		//wait for a client to connect
		clientSocket = accept(serverSocket, NULL, NULL);
		if (clientSocket == INVALID_SOCKET)
		{
			sError("Failed accept()");
			WSACleanup();
			return SS_ERROR;
		}
		else { printf("\nConnected"); }
		bytesRecv = SOCKET_ERROR;

		printf("%d", bytesRecv);

		while (bytesRecv == SOCKET_ERROR)
		{
			//receive the data that is being sent by the client max limit to 5000 bytes.
			bytesRecv = recv(clientSocket, str, 5000, 0);
			printf(str);
			strcpy(message, str);
			if (bytesRecv == 0 || bytesRecv == WSAECONNRESET)
			{
				printf("\nConnection Closed.\n");
				break;
			}
		}

		
		//close client socket
		closesocket(clientSocket);
		//close server socket
		closesocket(serverSocket);
		WSACleanup();
		return SS_OK;
	}
	else
	{
		printf("argument :%s", argv[1]);
		strcpy(message, argv[1]);
	}
	WSACleanup();
}
